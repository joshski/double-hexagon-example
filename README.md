# double-hexagon-example

An example of a design pattern I like to call the "double hexagon". Inspired by
the [hexagonal architecture](http://alistair.cockburn.us/Hexagonal+architecture)
the double hexagon involves running the exact same tests against the application
domain logic and the external user interface. Using ports and adapters in both
the test and application code means two hexagons are in use, one for the tests
and one for the application code.

[@aslakhellesoy](https://github.com/aslakhellesoy) taught me how to do this.

## Understanding the code

The [app test](./test/appTest.js) runs the same two simple test cases against
both the [Account domain object](./lib/domain/account.js) and the
[HTTP API](./lib/web/server/bankRoutes.js) by enumerating two different
configurations generated by [factories](./test/support/appFactories.js).

There are two implementations of the `AccountStore` contract:

  * [MemoryAccountStore](./lib/stores/accounts/memoryAccountStore.js)
  * [FlatFileAccountStore](./lib/stores/accounts/flatFileAccountStore.js)

These are covered by the same [contract test](./test/accountStoreTest.js) that
ensures they are interchangeable.

## Running the tests

Run the tests using the mocha shim:

    ./mocha

...which passes the `--harmony` flag to node, for `async/await` support as well
as any additional standard mocha arguments.

With no arguments mocha will run all tests against two configurations of the
app, first directly targeting the domain logic, secondly targeting the HTTP API:

```
  AccountStore (MemoryAccountStore)
    ✓ stores and retrieves accounts
    ✓ gets different account objects for the same account number
    ✓ stores copies of accounts

  AccountStore (FlatFileAccountStore)
    ✓ stores and retrieves accounts
    ✓ gets different account objects for the same account number
    ✓ stores copies of accounts

  AppCore (MemoryAccountStore)
    making a transfer
      ✓ decreases the balance of the sender account
      ✓ increases the balance of the receiver account

  AppCore (FlatFileAccountStore)
    making a transfer
      ✓ decreases the balance of the sender account
      ✓ increases the balance of the receiver account

  AppViaApi (MemoryAccountStore)
    making a transfer
      ✓ decreases the balance of the sender account
      ✓ increases the balance of the receiver account

  AppViaApi (FlatFileAccountStore)
    making a transfer
      ✓ decreases the balance of the sender account
      ✓ increases the balance of the receiver account


  14 passing (171ms)
```

Use the `-f` flag to run a subset for a particular hexagon-pair:

    ./mocha -f Core

...or all configurations using a particular `AccountStore` implementation:

    ./mocha -f FlatFileAccountStore
